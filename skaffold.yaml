apiVersion: skaffold/v4beta13
kind: Config
metadata:
  name: infra
deploy:
  kubectl: {}
manifests:
  kustomize:
    paths:
      - deploy/k8s/namespaces
      - deploy/k8s/postgres
---
apiVersion: skaffold/v4beta13
kind: Config
metadata:
  name: migrate
requires:
  - configs: [infra]
build:
  local:
    push: true
  artifacts:
    - image: order-migrate
      docker:
        dockerfile: deploy/images/order/migrate.Dockerfile
deploy:
  kubectl: {}
manifests:
  kustomize:
    paths:
      - deploy/k8s/migrate
---
apiVersion: skaffold/v4beta13
kind: Config
metadata:
  name: services
requires:
  - configs: [migrate]
build:
  local:
    push: true
  artifacts:
    - image: gateway
      ko:
        main: ./cmd/gateway
    - image: order
      ko:
        main: ./cmd/order
deploy:
  kubectl: {}
manifests:
  kustomize:
    paths:
      - deploy/k8s/gateway
      - deploy/k8s/order
